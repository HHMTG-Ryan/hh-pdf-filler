<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>HH Signing Package Builder – Launch</title>
  <link rel="icon" href="assets/images/hh-logo.png">
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:24px;max-width:900px}
    h1{font-size:22px;margin:0 0 12px} .muted{color:#666}
    textarea,button{width:100%;padding:10px;font-size:14px} button{cursor:pointer}
    .row{margin:12px 0} .ok{color:#1a7f37} .err{color:#b00020} .warn{color:#946200}
  </style>
</head>
<body>
  <h1>HH Signing Package Builder – Launch</h1>
  <noscript><div class="row err">JavaScript is required to launch the app.</div></noscript>
  <div id="status" class="muted">Checking for Zoho payload…</div>

  <div class="row" id="manual" style="display:none">
    <p class="muted">No Zoho payload detected. Paste JSON below to test, then click Launch.</p>
    <textarea id="manualJson" rows="8" placeholder='{"Contact_Name":"Ryan Smith","Lender_Name":"TD","City":"Kamloops"}'></textarea>
    <div class="row"><button id="launchBtn">Launch App</button></div>
  </div>

<script>
function setStatus(t,cls){ const s=document.getElementById('status'); s.textContent=t; s.className=cls||'muted'; }
function b64url(s){ return btoa(s).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,''); }
function tryJSON(t){ try{ const o=JSON.parse(t); return o&&typeof o==='object'?o:null; }catch{return null;} }

(function(){
  // 1) If ?data present, forward to app/ (relative, no leading slash)
  const params = new URLSearchParams(location.search);
  const qData = params.get('data');
  if(qData){
    location.replace('app/?data=' + encodeURIComponent(qData));
    return;
  }

  // 2) If window.name contains base64 JSON, convert to url-safe and forward
  try{
    if(window.name){
      const raw = atob(window.name.replace(/-/g,'+').replace(/_/g,'/').padEnd(Math.ceil(window.name.length/4)*4,'='));
      const obj = tryJSON(raw);
      if(obj){
        const dataParam = b64url(JSON.stringify(obj));
        location.replace('app/?data=' + encodeURIComponent(dataParam));
        return;
      }
    }
  }catch{}

  // 3) Manual mode for testing
  setStatus('No payload found. Use manual JSON to launch.', 'err');
  document.getElementById('manual').style.display = 'block';
  document.getElementById('launchBtn').addEventListener('click', ()=>{
    const t = document.getElementById('manualJson').value.trim();
    const obj = tryJSON(t);
    if(!obj){ alert('Invalid JSON'); return; }
    const dataParam = b64url(JSON.stringify(obj));
    location.replace('app/?data=' + encodeURIComponent(dataParam));
  });
})();
</script>
</body>
</html>
